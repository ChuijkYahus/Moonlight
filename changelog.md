many improvements and fixes related to 1.21 port