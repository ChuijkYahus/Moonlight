ported may recent changes from1.20